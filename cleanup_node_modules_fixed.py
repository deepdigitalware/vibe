#!/usr/bin/env python3
"""
Script to cleanup incorrectly uploaded node_modules from VPS
"""

import paramiko
import os
import time

def cleanup_node_modules():
    # VPS Configuration
    hostname = "31.97.206.179"
    username = "root"
    password = "Deep@SM#01170628"
    
    print("Connecting to VPS to cleanup node_modules...")
    
    # Create SSH client
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    
    try:
        # Connect to the VPS
        ssh.connect(hostname, username=username, password=password, timeout=10)
        print("✓ Successfully connected to VPS")
        
        print("\n--- Removing uploaded node_modules ---")
        
        # Remove the uploaded node_modules directory
        stdin, stdout, stderr = ssh.exec_command('rm -rf /var/www/admin.deepverse.cloud/vibe/node_modules')
        exit_status = stdout.channel.recv_exit_status()
        if exit_status == 0:
            print("✓ Removed node_modules directory")
        else:
            print("? node_modules directory may not have existed or was already removed")
        
        # Also remove any package-lock.json that might have been uploaded with the wrong approach
        stdin, stdout, stderr = ssh.exec_command('rm -f /var/www/admin.deepverse.cloud/vibe/package-lock.json')
        stdout.channel.recv_exit_status()
        print("✓ Removed package-lock.json if it existed")
        
        print("\n--- Installing server dependencies properly ---")
        
        # Install dependencies properly on the server
        commands = [
            'cd /var/www/admin.deepverse.cloud/vibe && npm install',
            'cd /var/www/admin.deepverse.cloud/vibe && npm audit fix || echo "Audit fix completed or had issues"'
        ]
        
        for cmd in commands:
            print(f"Running: {cmd}")
            stdin, stdout, stderr = ssh.exec_command(cmd)
            exit_status = stdout.channel.recv_exit_status()
            if exit_status == 0:
                print(f"✓ Success: {cmd}")
            else:
                output = stdout.read().decode()
                error = stderr.read().decode()
                print(f"Output: {output}")
                print(f"Error: {error}")
        
        print("\n--- Starting the application ---")
        
        # Start the application with PM2
        start_commands = [
            'cd /var/www/admin.deepverse.cloud/vibe && export PORT=9999 && pm2 stop index.js || true',
            'cd /var/www/admin.deepverse.cloud/vibe && export PORT=9999 && pm2 delete index.js || true',
            'cd /var/www/admin.deepverse.cloud/vibe && pm2 start index.js --name "vibe-admin" --env production -- --port 9999',
            'pm2 save',
            'pm2 startup'
        ]
        
        for cmd in start_commands:
            print(f"Running: {cmd}")
            stdin, stdout, stderr = ssh.exec_command(cmd)
            time.sleep(2)  # Allow time for PM2 commands to process
            exit_status = stdout.channel.recv_exit_status()
            if exit_status == 0:
                print(f"✓ Success: {cmd}")
            else:
                output = stdout.read().decode()
                error = stderr.read().decode()
                print(f"Command: {cmd}")
                print(f"Output: {output}")
                print(f"Error: {error}")
        
        print("\n" + "="*60)
        print("CLEANUP AND PROPER DEPLOYMENT COMPLETED!")
        print("="*60)
        print("Landing Page: http://vibe.deepverse.cloud:9000")
        print("Admin Panel: http://admin.deepverse.cloud:9999/vibe")
        print("Admin Login: Username: admin, Password: password")
        print("="*60)
        
        # Close connection
        ssh.close()
        print("\n✓ Connection to VPS closed")
        
    except Exception as e:
        print(f"\n✗ Error during cleanup: {str(e)}")
        if 'ssh' in locals():
            ssh.close()
        raise

if __name__ == "__main__":
    print("Starting cleanup of incorrectly uploaded node_modules...")
    cleanup_node_modules()